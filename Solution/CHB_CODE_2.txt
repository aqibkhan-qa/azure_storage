# Create services
Get-AzResourceGroup -Name $rgName -ErrorVariable notPresent
if ($notPresent)
{
New-AzResourceGroup $rgName -Location $regionName
}

Get-AzStorageAccount -Name ($storeName) -ResourceGroupName $rgName -ErrorVariable notPresent
if ($notPresent)
{
New-AzStorageAccount -ResourceGroupName $rgName `
-AccountName $storeName -SkuName Standard_LRS -Location $regionName `
-EnableHttpsTrafficOnly 1 -Kind "StorageV2"

$accountObject = Get-AzStorageAccount -ResourceGroupName $rgName `
-AccountName $storeName 
New-AzRmStorageContainer -StorageAccount $accountObject `
-ContainerName $project -PublicAccess None
}

if (!(Test-AzDataLakeStoreAccount -Name $storeName))
{
New-AzDataLakeStoreAccount -Name $storeName -Location $regionName `
-ResourceGroup $rgName -Encryption ServiceManaged
}

$hubsName = $rgName + "-" + "hubs"
if ((Test-AzEventHubName -Namespace $hubsName).NameAvailable)
{
New-AzEventHubNamespace -ResourceGroupName $rgName `
-NamespaceName $hubsName -Location $regionName `
-SkuName "Standard" -SkuCapacity 1 
New-AzEventHub -ResourceGroupName $rgName `
-NamespaceName $hubsName -Name $project `
-MessageRetentionInDays 1 -PartitionCount 2 
New-AzEventHubAuthorizationRule -ResourceGroupName $rgName `
-NamespaceName $hubsName -AuthorizationRuleName "hubsreader" `
-Rights @("Listen")
New-AzEventHubAuthorizationRule -ResourceGroupName $rgName `
-NamespaceName $hubsName -AuthorizationRuleName "hubswriter" `
-Rights @("Send")
}

$streamName = $rgName + "-" + "asa"
Get-AzStreamAnalyticsFunction -JobName $streamName -ResourceGroupName $rgName -ErrorVariable notPresent
if ($notPresent)
{
mkdir asa
cd asa
$jobConfig = @{}
$jobProp = @{}
$jobSku = @{name="standard"}
$jobProp.Add("sku",$jobSku)
$jobProp.Add("eventsOutOfOrderPolicy","adjust")
$jobProp.Add("eventsOutOfOrderMaxDelayInSeconds",11)
$jobProp.Add("compatibilityLevel",1.1)
$jobProp.Add("outputErrorPolicy","Stop")
$jobProp.Add("eventsLateArrivalMaxDelayInSeconds",6)
$jobConfig.Add("properties",$jobProp)
$jobConfig.Add("location","EastUS2")
$jobConfig | ConvertTo-Json -Depth 10 | Out-File -FilePath ./streamingjob.json
New-AzStreamAnalyticsJob -ResourceGroupName $rgName `
-Name ($streamName + "-" + $project) -File ./streamingjob.json 
cd ..
}

if (!(Test-AzDataLakeAnalyticsAccount -Name $storeName))
{
New-AzDataLakeAnalyticsAccount -ResourceGroupName $rgName -Name $storeName `
-Location $regionName -DefaultDataLakeStore $storeName -Tier "Consumption" 
}

$sqlName = $rgName + "-" + "sql"
Get-AzSqlServer -Name $sqlName -ResourceGroupName $rgName `
-ErrorVariable notPresent
if ($notPresent)
{
New-AzSqlServer -ResourceGroupName $rgName -Location $regionName `
-ServerName $sqlName -SqlAdministratorCredentials (Get-Credential) 
}

Get-AzSqlDatabase -Name ($sqlName + "-" + "stats") -ResourceGroupName `
$rgName -ServerName $sqlName -ErrorVariable notPresent
if ($notPresent)
{
New-AzSqlDatabase -ResourceGroupName $rgName -ServerName $sqlName `
-DatabaseName ($sqlName + "-" + "stats") -Edition "Basic" 
}


$vaultName = ($rgName + "-" + "ky")
Get-AzKeyVault -Name $vaultName -ResourceGroupName $rgName `
-ErrorVariable notPresent
if ([string]::IsNullOrWhiteSpace($notPresent))
{
New-AzKeyVault -Name $vaultName -ResourceGroupName $rgName `
-Location $regionName -EnablePurgeProtection -ErrorVariable deleted
}
if ($deleted)
{
Undo-AzKeyVaultRemoval -VaultName $vaultName -ResourceGroupName $rgName `
-Location $region
}

Get-AzDataFactoryV2 -Name ($rgName + "-" + "adf") -ResourceGroupName `
$rgName -ErrorVariable notPresent
if ($notPresent)
{
New-AzDataFactoryV2 -Name ($rgName + "-" + "adf") -Location $regionName `
-ResourceGroupName $rgName
}